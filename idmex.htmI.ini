<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>متجر المنتجات (للمالك فقط)</title>
    <!-- تحميل Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- خطوط وتصميم أساسي -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f7f9fb;
        }
        /* لتطبيق RTL بشكل أفضل على المكونات */
        .container {
            max-width: 800px;
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="container mx-auto bg-white shadow-xl rounded-2xl p-6 md:p-10">
        <h1 class="text-3xl font-bold text-center mb-6 text-indigo-700">نظام إدارة المنتجات</h1>
        
        <!-- معلومات المستخدم وحالة المالك -->
        <div id="auth-status" class="text-center mb-6 p-4 rounded-xl bg-indigo-50 border border-indigo-200">
            <p id="user-id-display" class="text-sm font-medium text-gray-700">تحميل بيانات المستخدم...</p>
            <p id="owner-status" class="mt-2 text-base font-bold"></p>
        </div>

        <!-- قسم إضافة المنتجات (للمالك فقط) -->
        <div id="add-product-section" class="border-2 border-dashed border-indigo-300 p-6 rounded-xl bg-indigo-50 hidden">
            <h2 class="text-xl font-semibold mb-4 text-indigo-800">إضافة منتج جديد (المالك)</h2>
            <form id="add-product-form">
                <div class="mb-4">
                    <label for="product-name" class="block text-sm font-medium text-gray-700 mb-1">اسم المنتج</label>
                    <input type="text" id="product-name" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-4">
                    <label for="product-price" class="block text-sm font-medium text-gray-700 mb-1">السعر (ريال)</label>
                    <input type="number" id="product-price" required min="0.01" step="0.01" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md">
                    إضافة المنتج
                </button>
            </form>
            <p id="message" class="mt-4 text-center hidden p-2 rounded-lg"></p>
        </div>

        <!-- قائمة المنتجات (مرئية للجميع) -->
        <div class="mt-8">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800">المنتجات المعروضة</h2>
            <div id="product-list" class="space-y-4">
                <!-- المنتجات ستظهر هنا -->
                <p id="loading-products" class="text-center text-gray-500">جاري تحميل المنتجات...</p>
            </div>
        </div>
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, setDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // setLogLevel('debug'); // لإظهار سجلات الأخطاء والتتبع في Console

        // المتغيرات العامة التي يوفرها النظام
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // تهيئة Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // متغيرات DOM
        const addProductSection = document.getElementById('add-product-section');
        const addProductForm = document.getElementById('add-product-form');
        const productNameInput = document.getElementById('product-name');
        const productPriceInput = document.getElementById('product-price');
        const productList = document.getElementById('product-list');
        const messageDisplay = document.getElementById('message');
        const userIdDisplay = document.getElementById('user-id-display');
        const ownerStatusDisplay = document.getElementById('owner-status');

        let userId = null;
        let isAuthReady = false;

        // **هام:** لتحديد من هو المالك، سنستخدم في هذا العرض التوضيحي معرف مستخدم (UID) محدد.
        // يجب استبدال هذا بمعرف المستخدم الحقيقي للمالك في تطبيقك الفعلي.
        // هنا سنستخدم معرف المستخدم الذي يسجل الدخول لأول مرة كـ "المالك".
        // في تطبيق حقيقي، يجب تخزين هذا المعرف في مكان آمن أو استخدام نظام أدوار (Roles).
        const DEMO_OWNER_ID = 'owner-12345'; 

        // 1. وظيفة تسجيل الدخول وتحديث حالة المالك
        async function setupAuth() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("خطأ في تسجيل الدخول:", error);
            }

            // الاستماع لحالة المصادقة
            onAuthStateChanged(auth, (user) => {
                isAuthReady = true;
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = `معرّف المستخدم (UID): ${userId}`;
                    
                    // محاكاة دور المالك
                    // *لأغراض العرض التوضيحي، سنفترض أن المستخدم الحالي هو المالك إذا كان UID يتطابق مع المعرّف التجريبي*
                    const isOwner = userId === DEMO_OWNER_ID; 
                    
                    if (isOwner) {
                        ownerStatusDisplay.textContent = "أنت حاليًا المالك. يمكنك إضافة المنتجات.";
                        ownerStatusDisplay.className = "mt-2 text-base font-bold text-green-700";
                        addProductSection.classList.remove('hidden');
                    } else {
                         ownerStatusDisplay.textContent = "أنت لست المالك. لا يمكنك إضافة المنتجات.";
                         ownerStatusDisplay.className = "mt-2 text-base font-bold text-red-700";
                         addProductSection.classList.add('hidden');
                         // إخفاء نموذج الإضافة يفي بالشرط "لي أنا بس المالك"
                    }

                    // بعد جاهزية المصادقة، نبدأ بتحميل البيانات
                    loadProducts();
                } else {
                    userId = null;
                    userIdDisplay.textContent = "لم يتم تسجيل الدخول.";
                    ownerStatusDisplay.textContent = "يرجى تسجيل الدخول لاستخدام ميزات المالك.";
                    ownerStatusDisplay.className = "mt-2 text-base font-bold text-red-700";
                    addProductSection.classList.add('hidden');
                }
            });
        }

        // 2. وظيفة إضافة منتج (تُنفذ فقط إذا كان نموذج المالك مرئياً)
        addProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!userId || userId !== DEMO_OWNER_ID) {
                showMessage("خطأ: أنت لست المالك المخول بإضافة منتج.", "error");
                return;
            }

            const name = productNameInput.value.trim();
            const price = parseFloat(productPriceInput.value);

            if (!name || isNaN(price) || price <= 0) {
                showMessage("الرجاء إدخال اسم وسعر صالحين للمنتج.", "error");
                return;
            }

            const productsCollectionPath = `/artifacts/${appId}/public/data/products`;

            try {
                // إضافة الوثيقة إلى مجموعة المنتجات العامة
                await addDoc(collection(db, productsCollectionPath), {
                    name: name,
                    price: price,
                    ownerId: userId, // تسجيل من قام بإضافة المنتج
                    createdAt: serverTimestamp()
                });
                
                showMessage("تم إضافة المنتج بنجاح!", "success");
                addProductForm.reset();
            } catch (error) {
                console.error("خطأ في إضافة المنتج:", error);
                showMessage("حدث خطأ أثناء إضافة المنتج. تحقق من سجلات وحدة التحكم.", "error");
            }
        });

        // 3. وظيفة عرض المنتجات في الوقت الفعلي
        function loadProducts() {
            if (!isAuthReady) return;

            const productsCollectionPath = `/artifacts/${appId}/public/data/products`;
            const productsQuery = query(collection(db, productsCollectionPath));
            
            // الاستماع للتغييرات في الوقت الفعلي
            onSnapshot(productsQuery, (snapshot) => {
                productList.innerHTML = ''; // مسح القائمة الحالية
                
                if (snapshot.empty) {
                    productList.innerHTML = '<p class="text-center text-gray-500 p-4 bg-gray-100 rounded-lg">لا توجد منتجات لعرضها بعد.</p>';
                    return;
                }

                snapshot.forEach((doc) => {
                    const product = doc.data();
                    const productElement = document.createElement('div');
                    productElement.className = 'flex justify-between items-center p-4 bg-gray-50 border border-gray-200 rounded-xl hover:shadow-md transition duration-150';
                    productElement.innerHTML = `
                        <div>
                            <p class="text-lg font-semibold text-gray-900">${product.name}</p>
                            <p class="text-sm text-gray-500">تم إضافته بواسطة: <span class="font-mono text-xs">${product.ownerId.substring(0, 8)}...</span></p>
                        </div>
                        <p class="text-xl font-bold text-indigo-600">${product.price.toFixed(2)} ريال</p>
                    `;
                    productList.appendChild(productElement);
                });
            }, (error) => {
                console.error("خطأ في جلب المنتجات:", error);
                productList.innerHTML = '<p class="text-red-500 p-4 bg-red-100 rounded-lg">خطأ في تحميل قائمة المنتجات.</p>';
            });
        }
        
        // 4. وظيفة عرض الرسائل للمستخدم (نجاح/خطأ)
        function showMessage(text, type) {
            messageDisplay.textContent = text;
            messageDisplay.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
            
            if (type === 'success') {
                messageDisplay.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                messageDisplay.classList.add('bg-red-100', 'text-red-800');
            }
            
            setTimeout(() => {
                messageDisplay.classList.add('hidden');
            }, 5000);
        }

        // 5. بدء عملية المصادقة
        setupAuth();

    </script>
</body>
</html>import React, { useState, useEffect } from 'react';
import { 
  ShoppingBag, 
  User, 
  Plus, 
  Trash2, 
  Edit, 
  CheckCircle, 
  LogOut, 
  Search,
  Truck,
  MapPin,
  Smartphone,
  Sparkles,
  BarChart3,
  X
} from 'lucide-react';

// --- Mock Data & Constants ---

const INITIAL_PRODUCTS = [
  { id: 1, name: 'قميص كتان كلاسيكي', price: 85, category: 'قمصان', image: '/api/placeholder/300/400', description: 'قميص كتان عالي الجودة مناسب للأجواء الصيفية، متوفر بعدة ألوان.' },
  { id: 2, name: 'بنطلون جينز سليم', price: 120, category: 'بناطيل', image: '/api/placeholder/300/400', description: 'جينز مريح وعملي، قصة سليم فت تناسب جميع الأوقات.' },
  { id: 3, name: 'بدلة رسمية (جاكيت + بنطلون)', price: 450, category: 'بدل', image: '/api/placeholder/300/400', description: 'بدلة رسمية فاخرة للمناسبات والعمل، خامة إيطالية ممتازة.' },
  { id: 4, name: 'حذاء جلد طبيعي', price: 210, category: 'أحذية', image: '/api/placeholder/300/400', description: 'حذاء جلد طبيعي محلي الصنع، راحة وفخامة.' },
  { id: 5, name: 'تيشيرت بولو', price: 65, category: 'تيشيرتات', image: '/api/placeholder/300/400', description: 'تيشيرت قطني 100% مريح جداً للاستخدام اليومي.' },
];

const CITIES = [
  "طرابلس", "بنغازي", "مصراتة", "الزاوية", "سبها", "طبرق", "البيضاء", "زليتن", "غريان", "درنة"
];

// --- Shared Components ---

const Button = ({ children, onClick, variant = 'primary', className = '', type = 'button', disabled = false }) => {
  const baseStyle = "px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2";
  const variants = {
    primary: "bg-emerald-700 text-white hover:bg-emerald-800 disabled:bg-emerald-300",
    secondary: "bg-gray-100 text-gray-800 hover:bg-gray-200",
    danger: "bg-red-50 text-red-600 hover:bg-red-100",
    outline: "border border-emerald-700 text-emerald-700 hover:bg-emerald-50"
  };

  return (
    <button 
      type={type} 
      onClick={onClick} 
      disabled={disabled}
      className={`${baseStyle} ${variants[variant]} ${className}`}
    >
      {children}
    </button>
  );
};

const Input = ({ label, ...props }) => (
  <div className="mb-4">
    <label className="block text-sm font-medium text-gray-700 mb-1">{label}</label>
    <input 
      className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all"
      {...props}
    />
  </div>
);

const Navbar = ({ user, cartCount, setView, onLogout }) => (
  <nav className="bg-white shadow-md sticky top-0 z-50 px-4 py-3" dir="rtl">
    <div className="max-w-6xl mx-auto flex justify-between items-center">
      <div className="flex items-center gap-2 cursor-pointer" onClick={() => setView(user?.role === 'admin' ? 'admin' : 'home')}>
        <div className="bg-emerald-700 p-2 rounded-lg text-white">
          <ShoppingBag size={24} />
        </div>
        <h1 className="text-xl font-bold text-gray-800 hidden sm:block">أناقة ليبيا</h1>
      </div>

      <div className="flex items-center gap-4">
        {user?.role === 'admin' ? (
           <Button variant="outline" onClick={() => setView('admin')} className="hidden sm:flex">
             <BarChart3 size={18} /> لوحة التحكم
           </Button>
        ) : (
          <>
            <div className="relative cursor-pointer" onClick={() => setView('cart')}>
              <ShoppingBag className="text-gray-600 hover:text-emerald-700 transition" />
              {cartCount > 0 && (
                <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold">
                  {cartCount}
                </span>
              )}
            </div>
          </>
        )}

        {user ? (
          <div className="flex items-center gap-3">
            <span className="text-sm font-medium text-gray-600 hidden sm:block">مرحباً، {user.name}</span>
            <Button variant="secondary" onClick={onLogout} className="!px-3 !py-1 text-sm">
              <LogOut size={16} />
            </Button>
          </div>
        ) : (
          <Button onClick={() => setView('login')} className="!px-4 !py-1.5 text-sm">
            <User size={18} /> تسجيل
          </Button>
        )}
      </div>
    </div>
  </nav>
);

const ProductCard = ({ product, onAddToCart }) => (
  <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-lg transition-shadow group">
    <div className="h-64 bg-gray-100 relative overflow-hidden">
      <img src={product.image} alt={product.name} className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" />
      <div className="absolute top-2 right-2 bg-white/90 backdrop-blur px-2 py-1 rounded text-xs font-bold text-emerald-800">
        {product.category}
      </div>
    </div>
    <div className="p-4">
      <h3 className="font-bold text-gray-800 mb-1">{product.name}</h3>
      <p className="text-emerald-700 font-bold text-lg mb-2">{product.price} د.ل</p>
      <p className="text-gray-500 text-sm mb-4 line-clamp-2">{product.description}</p>
      <Button onClick={() => onAddToCart(product)} className="w-full">
        أضف للسلة <Plus size={18} />
      </Button>
    </div>
  </div>
);

// --- View Components ---

const HomeView = ({ products, searchQuery, setSearchQuery, selectedCategory, setSelectedCategory, onAddToCart }) => {
  const filteredProducts = products.filter(p => 
    (selectedCategory === 'الكل' || p.category === selectedCategory) &&
    p.name.toLowerCase().includes(searchQuery.toLowerCase())
  );
  
  // Use Set to get unique categories, filter out empty ones
  const categories = ['الكل', ...new Set(products.map(p => p.category).filter(Boolean))];

  return (
    <div className="space-y-8 animate-fade-in">
      {/* Hero Section */}
      <div className="bg-emerald-900 rounded-2xl p-8 text-white relative overflow-hidden">
        <div className="relative z-10 max-w-lg">
          <h2 className="text-3xl font-bold mb-4">أرقى الملابس الرجالية في ليبيا</h2>
          <p className="text-emerald-100 mb-6">اكتشف تشكيلة مميزة من الملابس العصرية والتقليدية. توصيل سريع لكافة المدن الليبية.</p>
          <div className="flex gap-2">
            <div className="flex-1 bg-white/10 backdrop-blur rounded-lg p-3 flex items-center border border-white/20">
              <Search className="text-white/60 ml-2" />
              <input 
                type="text" 
                placeholder="عن ماذا تبحث؟" 
                className="bg-transparent border-none outline-none text-white placeholder-white/60 w-full"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
              />
            </div>
          </div>
        </div>
        <div className="absolute top-0 left-0 w-full h-full bg-gradient-to-r from-emerald-900 to-transparent"></div>
        <div className="absolute -bottom-10 -left-10 w-40 h-40 bg-emerald-500 rounded-full opacity-20 blur-3xl"></div>
      </div>

      {/* Categories */}
      <div className="flex gap-2 overflow-x-auto pb-2">
        {categories.map(cat => (
          <button 
            key={cat}
            onClick={() => setSelectedCategory(cat)}
            className={`px-6 py-2 rounded-full whitespace-nowrap transition-colors ${
              selectedCategory === cat 
              ? 'bg-emerald-700 text-white' 
              : 'bg-white border border-gray-200 text-gray-600 hover:bg-gray-50'
            }`}
          >
            {cat}
          </button>
        ))}
      </div>

      {/* Product Grid */}
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {filteredProducts.map(product => (
          <ProductCard key={product.id} product={product} onAddToCart={onAddToCart} />
        ))}
      </div>
      
      {filteredProducts.length === 0 && (
        <div className="text-center py-12 text-gray-500">
          لا توجد منتجات تطابق بحثك.
        </div>
      )}
    </div>
  );
};

const CartView = ({ cart, onUpdateQty, onRemove, setView, cartTotal }) => (
  <div className="max-w-2xl mx-auto">
    <h2 className="text-2xl font-bold mb-6 flex items-center gap-2">
      <ShoppingBag /> سلة التسوق
    </h2>
    
    {cart.length === 0 ? (
      <div className="text-center py-12 bg-white rounded-xl border border-dashed border-gray-300">
        <p className="text-gray-500 mb-4">سلتك فارغة حالياً</p>
        <Button onClick={() => setView('home')}>تصفح المنتجات</Button>
      </div>
    ) : (
      <div className="space-y-6">
        <div className="bg-white rounded-xl shadow-sm overflow-hidden divide-y divide-gray-100">
          {cart.map(item => (
            <div key={item.id} className="p-4 flex gap-4 items-center">
              <div className="w-20 h-20 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0">
                <img src={item.image} alt={item.name} className="w-full h-full object-cover" />
              </div>
              <div className="flex-1">
                <h3 className="font-bold text-gray-800">{item.name}</h3>
                <p className="text-emerald-700 font-bold">{item.price} د.ل</p>
              </div>
              <div className="flex items-center gap-3">
                <button onClick={() => onUpdateQty(item.id, -1)} className="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200">-</button>
                <span className="font-medium w-4 text-center">{item.qty}</span>
                <button onClick={() => onUpdateQty(item.id, 1)} className="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center hover:bg-gray-200">+</button>
              </div>
              <button onClick={() => onRemove(item.id)} className="text-red-500 hover:text-red-700 p-2">
                <Trash2 size={18} />
              </button>
            </div>
          ))}
        </div>

        <div className="bg-white rounded-xl shadow-sm p-6">
          <div className="flex justify-between items-center mb-4 text-lg font-bold">
            <span>الإجمالي:</span>
            <span className="text-emerald-700">{cartTotal} د.ل</span>
          </div>
          <Button className="w-full py-3" onClick={() => setView('checkout')}>
            إتمام الشراء والدفع
          </Button>
        </div>
      </div>
    )}
  </div>
);

const CheckoutView = ({ user, setView, onPlaceOrder, cartTotal }) => {
  const [formData, setFormData] = useState({
    name: user?.name || '',
    phone: '',
    city: 'طرابلس',
    address: '',
    notes: ''
  });

  const handleSubmit = (e) => {
    e.preventDefault();
    onPlaceOrder(formData);
  };

  return (
    <div className="max-w-2xl mx-auto">
      <Button variant="secondary" onClick={() => setView('cart')} className="mb-6">
        رجوع للسلة
      </Button>
      
      <div className="bg-white rounded-xl shadow-sm p-8">
        <h2 className="text-2xl font-bold mb-6 border-b pb-4">بيانات الشحن والدفع</h2>
        <form onSubmit={handleSubmit} className="space-y-4">
          <Input 
            label="الاسم الكامل" 
            value={formData.name}
            onChange={e => setFormData({...formData, name: e.target.value})}
            required 
          />
          <Input 
            label="رقم الهاتف (ليبي)" 
            placeholder="09X-XXXXXXX"
            value={formData.phone}
            onChange={e => setFormData({...formData, phone: e.target.value})}
            required 
          />
          
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700 mb-1">المدينة</label>
            <select 
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none"
              value={formData.city}
              onChange={e => setFormData({...formData, city: e.target.value})}
            >
              {CITIES.map(city => <option key={city} value={city}>{city}</option>)}
            </select>
          </div>

          <Input 
            label="العنوان بالتفصيل (المنطقة، الشارع، علامة مميزة)" 
            value={formData.address}
            onChange={e => setFormData({...formData, address: e.target.value})}
            required 
          />

          <div className="bg-emerald-50 p-4 rounded-lg border border-emerald-100 flex items-start gap-3 mt-6">
            <Truck className="text-emerald-700 mt-1" size={20} />
            <div>
              <h4 className="font-bold text-emerald-900">طريقة الدفع</h4>
              <p className="text-emerald-800 text-sm">الدفع نقداً عند الاستلام (COD) متاح لجميع المدن الليبية.</p>
            </div>
          </div>

          <Button type="submit" className="w-full mt-6 py-3 text-lg">
            تأكيد الطلب ({cartTotal} د.ل)
          </Button>
        </form>
      </div>
    </div>
  );
};

const AdminView = ({ products, setProducts, orders, setOrders }) => {
  const [tab, setTab] = useState('orders'); // orders, products
  const [isEditing, setIsEditing] = useState(false);
  const [currentProduct, setCurrentProduct] = useState({});

  // AI Simulation for descriptions
  const generateAIDescription = (name, category) => {
      const adjectives = ["أنيق", "عصري", "فاخر", "مميز", "مريح"];
      const features = ["خامة ممتازة", "تصميم يلائم الجميع", "سعر منافس", "صناعة عالية الجودة"];
      const randAdj = adjectives[Math.floor(Math.random() * adjectives.length)];
      const randFeat = features[Math.floor(Math.random() * features.length)];
      
      return `${name} ${category} ${randAdj}. يتميز بأنه ${randFeat}. احصل عليه الآن واضف لمسة من الأناقة لمظهرك.`;
  };

  const handleSaveProduct = (e) => {
    e.preventDefault();
    if (currentProduct.id) {
      setProducts(products.map(p => p.id === currentProduct.id ? currentProduct : p));
    } else {
      setProducts([...products, { ...currentProduct, id: Date.now(), image: '/api/placeholder/300/400' }]);
    }
    setIsEditing(false);
    setCurrentProduct({});
  };

  const handleDeleteProduct = (id) => {
    if (window.confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
      setProducts(products.filter(p => p.id !== id));
    }
  };

  const toggleOrderStatus = (orderId) => {
      setOrders(orders.map(o => 
          o.id === orderId 
          ? { ...o, status: o.status === 'pending' ? 'delivered' : 'pending' } 
          : o
      ));
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center bg-white p-6 rounded-xl shadow-sm border-r-4 border-emerald-700">
        <div>
          <h2 className="text-2xl font-bold">لوحة تحكم المدير</h2>
          <p className="text-gray-500">إدارة المتجر والطلبات</p>
        </div>
        <div className="flex gap-2">
          <Button variant={tab === 'orders' ? 'primary' : 'secondary'} onClick={() => setTab('orders')}>
             الطلبات ({orders.filter(o => o.status === 'pending').length})
          </Button>
          <Button variant={tab === 'products' ? 'primary' : 'secondary'} onClick={() => setTab('products')}>
            المنتجات
          </Button>
        </div>
      </div>

      {tab === 'products' && (
        <div className="bg-white rounded-xl shadow-sm p-6">
          <div className="flex justify-between items-center mb-6">
            <h3 className="font-bold text-lg">قائمة المنتجات</h3>
            <Button onClick={() => { setIsEditing(true); setCurrentProduct({}); }}>
              <Plus size={18} /> إضافة منتج
            </Button>
          </div>

          {isEditing && (
            <div className="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200">
              <h4 className="font-bold mb-4">{currentProduct.id ? 'تعديل منتج' : 'إضافة منتج جديد'}</h4>
              <form onSubmit={handleSaveProduct} className="space-y-3">
                <div className="grid grid-cols-2 gap-4">
                  <Input 
                    label="اسم المنتج" 
                    value={currentProduct.name || ''} 
                    onChange={e => setCurrentProduct({...currentProduct, name: e.target.value})} 
                    required
                  />
                  <Input 
                    label="السعر (د.ل)" 
                    type="number" 
                    value={currentProduct.price || ''} 
                    onChange={e => setCurrentProduct({...currentProduct, price: Number(e.target.value)})} 
                    required
                  />
                </div>
                <Input 
                  label="القسم (مثال: قمصان)" 
                  value={currentProduct.category || ''} 
                  onChange={e => setCurrentProduct({...currentProduct, category: e.target.value})} 
                />
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">الوصف</label>
                  <textarea 
                    className="w-full px-4 py-2 border border-gray-300 rounded-lg h-24 mb-2"
                    value={currentProduct.description || ''}
                    onChange={e => setCurrentProduct({...currentProduct, description: e.target.value})}
                  ></textarea>
                  <Button 
                      type="button" 
                      variant="outline" 
                      className="text-xs"
                      onClick={() => {
                          if(!currentProduct.name) return alert('اكتب الاسم أولاً');
                          setCurrentProduct({
                              ...currentProduct, 
                              description: generateAIDescription(currentProduct.name, currentProduct.category || 'ملابس')
                          })
                      }}
                  >
                      <Sparkles size={14} /> توليد وصف بالذكاء الاصطناعي
                  </Button>
                </div>
                <div className="flex gap-2 justify-end">
                  <Button variant="secondary" onClick={() => setIsEditing(false)}>إلغاء</Button>
                  <Button type="submit">حفظ</Button>
                </div>
              </form>
            </div>
          )}

          <div className="overflow-x-auto">
            <table className="w-full text-right">
              <thead className="bg-gray-50 text-gray-600 font-medium">
                <tr>
                  <th className="p-3">المنتج</th>
                  <th className="p-3">القسم</th>
                  <th className="p-3">السعر</th>
                  <th className="p-3">إجراءات</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-100">
                {products.map(p => (
                  <tr key={p.id}>
                    <td className="p-3 font-medium">{p.name}</td>
                    <td className="p-3">{p.category}</td>
                    <td className="p-3">{p.price} د.ل</td>
                    <td className="p-3 flex gap-2">
                      <button onClick={() => { setCurrentProduct(p); setIsEditing(true); }} className="text-blue-600 hover:bg-blue-50 p-2 rounded"><Edit size={18} /></button>
                      <button onClick={() => handleDeleteProduct(p.id)} className="text-red-600 hover:bg-red-50 p-2 rounded"><Trash2 size={18} /></button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}

      {tab === 'orders' && (
        <div className="space-y-4">
          {orders.length === 0 && <p className="text-center text-gray-500 bg-white p-8 rounded-xl">لا توجد طلبات بعد.</p>}
          {orders.map(order => (
            <div key={order.id} className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col md:flex-row gap-6">
              <div className="flex-1">
                  <div className="flex justify-between items-start mb-4">
                      <div>
                          <span className="text-xs font-bold text-gray-400">#{order.id}</span>
                          <h4 className="font-bold text-lg">{order.shipping.name}</h4>
                          <div className="text-gray-500 text-sm flex flex-col gap-1 mt-1">
                              <span className="flex items-center gap-1"><Smartphone size={14}/> {order.shipping.phone}</span>
                              <span className="flex items-center gap-1"><MapPin size={14}/> {order.shipping.city} - {order.shipping.address}</span>
                          </div>
                      </div>
                      <div className={`px-3 py-1 rounded-full text-sm font-bold ${order.status === 'delivered' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}`}>
                          {order.status === 'delivered' ? 'تم التوصيل' : 'قيد الانتظار'}
                      </div>
                  </div>
                  <div className="bg-gray-50 p-3 rounded-lg">
                      <h5 className="font-bold text-sm mb-2">المنتجات المطلوبة:</h5>
                      <ul className="text-sm space-y-1">
                          {order.items.map(i => (
                              <li key={i.id} className="flex justify-between">
                                  <span>{i.qty}x {i.name}</span>
                                  <span>{i.price * i.qty} د.ل</span>
                              </li>
                          ))}
                      </ul>
                      <div className="border-t border-gray-200 mt-2 pt-2 flex justify-between font-bold">
                          <span>الإجمالي</span>
                          <span>{order.total} د.ل</span>
                      </div>
                  </div>
              </div>
              <div className="flex flex-col justify-center border-t md:border-t-0 md:border-r md:pr-6 border-gray-100 pt-4 md:pt-0">
                  <Button 
                      onClick={() => toggleOrderStatus(order.id)}
                      variant={order.status === 'pending' ? 'primary' : 'outline'}
                  >
                      {order.status === 'pending' ? 'تحديد كمكتمل' : 'إعادة للانتظار'}
                  </Button>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

const AuthView = ({ mode, onLogin, setView }) => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');

  const handleSubmit = (e) => {
    e.preventDefault();
    onLogin(email, password);
  };

  return (
    <div className="max-w-md mx-auto mt-10 bg-white p-8 rounded-2xl shadow-lg">
      <h2 className="text-2xl font-bold text-center mb-6">{mode === 'login' ? 'تسجيل الدخول' : 'إنشاء حساب جديد'}</h2>
      <form onSubmit={handleSubmit} className="space-y-4">
        <Input 
          label="البريد الإلكتروني" 
          type="email" 
          value={email} 
          onChange={(e) => setEmail(e.target.value)}
          required 
        />
        <Input 
          label="كلمة المرور" 
          type="password" 
          value={password} 
          onChange={(e) => setPassword(e.target.value)}
          required 
        />
        <Button type="submit" className="w-full py-3">
          {mode === 'login' ? 'دخول' : 'تسجيل'}
        </Button>
      </form>
      <div className="mt-4 text-center">
          {mode === 'login' ? (
              <p className="text-sm text-gray-600">
                  للتجربة كمدير: admin@shop.ly / admin123
              </p>
          ) : null}
          <button 
              onClick={() => setView('home')} 
              className="text-emerald-700 text-sm mt-4 hover:underline"
          >
              تخطي والدخول كضيف
          </button>
      </div>
    </div>
  );
};

const OrderSuccessView = ({ setView }) => (
    <div className="max-w-md mx-auto text-center py-12 bg-white rounded-xl shadow-sm mt-8">
        <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600">
            <CheckCircle size={40} />
        </div>
        <h2 className="text-2xl font-bold mb-2">تم استلام طلبك بنجاح!</h2>
        <p className="text-gray-500 mb-6 px-6">شكراً لثقتك بنا. سيتم التواصل معك قريباً لتأكيد موعد التوصيل.</p>
        <Button onClick={() => setView('home')}>العودة للرئيسية</Button>
    </div>
);

// --- Main Application ---

export default function App() {
  // State
  const [view, setView] = useState('home'); // home, cart, checkout, login, register, admin
  const [user, setUser] = useState(null); // { name, email, role: 'admin' | 'user' }
  const [products, setProducts] = useState(INITIAL_PRODUCTS);
  const [cart, setCart] = useState([]);
  const [orders, setOrders] = useState([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedCategory, setSelectedCategory] = useState('الكل');

  // Load data
  useEffect(() => {
    const savedOrders = localStorage.getItem('libyaShopOrders');
    if (savedOrders) setOrders(JSON.parse(savedOrders));
    
    const savedProducts = localStorage.getItem('libyaShopProducts');
    if (savedProducts) setProducts(JSON.parse(savedProducts));
  }, []);

  // Persist data
  useEffect(() => {
    localStorage.setItem('libyaShopOrders', JSON.stringify(orders));
    localStorage.setItem('libyaShopProducts', JSON.stringify(products));
  }, [orders, products]);

  // Actions
  const addToCart = (product) => {
    const existing = cart.find(item => item.id === product.id);
    if (existing) {
      setCart(cart.map(item => item.id === product.id ? { ...item, qty: item.qty + 1 } : item));
    } else {
      setCart([...cart, { ...product, qty: 1 }]);
    }
  };

  const removeFromCart = (id) => {
    setCart(cart.filter(item => item.id !== id));
  };

  const updateCartQty = (id, delta) => {
    setCart(cart.map(item => {
      if (item.id === id) {
        const newQty = Math.max(1, item.qty + delta);
        return { ...item, qty: newQty };
      }
      return item;
    }));
  };

  const cartTotal = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);

  const handleLogin = (email, password) => {
    if (email === 'admin@shop.ly' && password === 'admin123') {
      setUser({ name: 'المدير', email, role: 'admin' });
      setView('admin');
    } else {
      setUser({ name: 'زبون كريم', email, role: 'user' });
      setView('home');
    }
  };

  const handleLogout = () => {
    setUser(null);
    setView('home');
    setCart([]);
  };

  const handlePlaceOrder = (shippingData) => {
    const newOrder = {
      id: Date.now(),
      customer: user || { name: shippingData.name, email: 'guest' },
      shipping: shippingData,
      items: cart,
      total: cartTotal,
      status: 'pending', // pending, delivered, cancelled
      date: new Date().toLocaleDateString('ar-LY'),
    };
    setOrders([newOrder, ...orders]);
    setCart([]);
    setView('order-success');
  };

  return (
    <div className="min-h-screen bg-gray-50 text-gray-800 font-sans pb-12" dir="rtl">
      {view !== 'login' && view !== 'register' && (
        <Navbar 
          user={user} 
          cartCount={cart.length} 
          setView={setView} 
          onLogout={handleLogout} 
        />
      )}
      
      <main className="container mx-auto px-4 py-6">
        {view === 'home' && (
          <HomeView 
            products={products}
            searchQuery={searchQuery}
            setSearchQuery={setSearchQuery}
            selectedCategory={selectedCategory}
            setSelectedCategory={setSelectedCategory}
            onAddToCart={addToCart}
          />
        )}
        
        {view === 'cart' && (
          <CartView 
            cart={cart}
            onUpdateQty={updateCartQty}
            onRemove={removeFromCart}
            setView={setView}
            cartTotal={cartTotal}
          />
        )}
        
        {view === 'checkout' && (
          <CheckoutView 
            user={user}
            setView={setView}
            onPlaceOrder={handlePlaceOrder}
            cartTotal={cartTotal}
          />
        )}
        
        {view === 'admin' && (
          <AdminView 
            products={products}
            setProducts={setProducts}
            orders={orders}
            setOrders={setOrders}
          />
        )}
        
        {(view === 'login' || view === 'register') && (
          <AuthView 
            mode={view} 
            onLogin={handleLogin}
            setView={setView}
          />
        )}
        
        {view === 'order-success' && <OrderSuccessView setView={setView} />}
      </main>
    </div>
  );
}